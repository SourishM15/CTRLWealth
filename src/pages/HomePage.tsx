import React, { useEffect, useRef, useState } from 'react';
import * as d3 from 'd3';
import ChatInterface from '../components/ChatInterface';
import { usMetrics, washingtonMetrics } from '../data/inequalityData';

// Washington state GeoJSON data
const washingtonCoordinates = {
  "type": "Feature",
  "properties": {
    "name": "Washington",
    "abbreviation": "WA"
  },
  "geometry": {
    "type": "Polygon",
    "coordinates": [[
      [-124.836097717285, 48.8048133468628],
      [-123.922508239746, 48.7954940795898],
      [-123.509674072266, 48.7513542175293],
      [-123.233039855957, 48.5844039916992],
      [-123.119674682617, 48.5149383544922],
      [-123.160400390625, 48.5299415588379],
      [-123.163047790527, 48.5355072021484],
      [-123.151931762695, 48.5396842956543],
      [-123.161376953125, 48.5476112365723],
      [-123.172401428223, 48.5564804077148],
      [-123.176254272461, 48.5621337890625],
      [-123.175842285156, 48.5684814453125],
      [-123.171951293945, 48.5722541809082],
      [-123.173049926758, 48.5790863037109],
      [-123.184928894043, 48.5869674682617],
      [-123.197746276855, 48.5862159729004],
      [-123.202674865723, 48.5902137756348],
      [-123.203018188477, 48.5961799621582],
      [-123.195716857910, 48.6070556640625],
      [-123.178413391113, 48.6221160888672],
      [-123.151634216309, 48.6236877441406],
      [-123.139694213867, 48.6227874755859],
      [-123.135635375977, 48.6201705932617],
      [-123.107353210449, 48.6224517822266],
      [-123.098449707031, 48.6128349304199],
      [-123.098243713379, 48.6100921630859],
      [-123.102066040039, 48.6040344238281],
      [-123.101547241211, 48.5978202819824],
      [-123.074600219727, 48.5918159484863],
      [-123.060028076172, 48.5821075439453],
      [-123.048393249512, 48.5692176818848],
      [-123.033660888672, 48.5634078979492],
      [-123.015037536621, 48.5608215332031],
      [-122.987289428711, 48.5618934631348],
      [-122.986099243164, 48.5699844360352],
      [-122.989639282227, 48.5746688842773],
      [-122.995018005371, 48.5781631469727],
      [-123.004791259766, 48.5807876586914],
      [-123.016639709473, 48.5802459716797],
      [-123.034088134766, 48.5917663574219],
      [-123.024894714355, 48.5944824218750],
      [-123.023422241211, 48.5994758605957],
      [-123.041175842285, 48.6119461059570],
      [-123.046524047852, 48.6114883422852],
      [-123.048645019531, 48.6210021972656],
      [-123.023483276367, 48.6340026855469],
      [-123.015579223633, 48.6425666809082],
      [-123.014816284180, 48.6475028991699],
      [-123.009910583496, 48.6550636291504],
      [-122.988876342773, 48.6672477722168],
      [-122.984840393066, 48.6726875305176],
      [-122.949104309082, 48.6933975219727],
      [-122.941307067871, 48.7029037475586],
      [-122.942359924316, 48.7067222595215],
      [-122.918243408203, 48.7135047912598],
      [-122.894592285156, 48.7150306701660],
      [-122.875930786133, 48.7121200561523],
      [-122.833114624023, 48.6981735229492],
      [-122.802536010742, 48.6826820373535],
      [-122.800262451172, 48.6796188354492],
      [-122.743041992188, 48.6619911193848],
      [-122.742073059082, 48.6606903076172],
      [-122.755020141602, 48.6495132446289],
      [-122.783866882324, 48.6354179382324],
      [-122.792137145996, 48.6335029602051],
      [-122.809616088867, 48.6190338134766],
      [-122.808853149414, 48.6153106689453],
      [-122.799003601074, 48.6046829223633],
      [-122.798759460449, 48.6023521423340],
      [-122.800209045410, 48.6016883850098],
      [-122.804862976074, 48.5959320068359],
      [-122.801086425781, 48.5854263305664],
      [-122.786575317383, 48.5766677856445],
      [-122.771194458008, 48.5624275207520],
      [-122.770339965820, 48.5581054687500],
      [-122.772377014160, 48.5521430969238],
      [-122.782608032227, 48.5451927185059],
      [-122.788497924805, 48.5303916931152],
      [-122.787338256836, 48.5230102539062],
      [-122.777458190918, 48.5177993774414],
      [-122.779113769531, 48.5089111328125],
      [-122.800407409668, 48.4944686889648],
      [-122.816322326660, 48.4878425598145],
      [-122.817901611328, 48.4838867187500],
      [-122.819717407227, 48.4588432312012],
      [-122.813087463379, 48.4528579711914],
      [-122.807701110840, 48.4440574645996],
      [-122.802497863770, 48.4330978393555],
      [-122.803512573242, 48.4287490844727],
      [-122.812202453613, 48.4223251342773],
      [-122.825790405273, 48.4241294860840],
      [-122.874122619629, 48.4181976318359],
      [-122.883750915527, 48.4187927246094],
      [-122.893638610840, 48.4226531982422],
      [-122.889007568359, 48.4359474182129],
      [-122.903205871582, 48.4369773864746],
      [-122.913879394531, 48.4432296752930],
      [-122.917762756348, 48.4397811889648],
      [-122.927993774414, 48.4399642944336],
      [-122.916450500488, 48.4532623291016],
      [-122.920089721680, 48.4584274291992],
      [-122.926895141602, 48.4608726501465],
      [-122.937873840332, 48.4562187194824],
      [-122.962005615234, 48.4511604309082],
      [-123.039146423340, 48.4600028991699],
      [-123.058143615723, 48.4715232849121],
      [-123.067665100098, 48.4794960021973],
      [-123.119438171387, 48.4925765991211],
      [-123.141471862793, 48.5052909851074],
      [-123.151054382324, 48.5139541625977],
      [-123.163223266602, 48.5295448303223],
      [-123.164047241211, 48.5356216430664],
      [-123.161842346191, 48.5392532348633],
      [-123.161460876465, 48.5476188659668],
      [-123.172401428223, 48.5564804077148],
      [-123.176254272461, 48.5621337890625],
      [-123.175842285156, 48.5684814453125],
      [-123.171951293945, 48.5722541809082],
      [-123.173049926758, 48.5790863037109],
      [-123.184928894043, 48.5869674682617],
      [-123.197746276855, 48.5862159729004],
      [-123.202674865723, 48.5902137756348],
      [-123.203018188477, 48.5961799621582],
      [-123.195716857910, 48.6070556640625],
      [-123.178413391113, 48.6221160888672],
      [-123.151634216309, 48.6236877441406],
      [-123.139694213867, 48.6227874755859],
      [-123.135635375977, 48.6201705932617],
      [-123.107353210449, 48.6224517822266],
      [-123.098449707031, 48.6128349304199],
      [-123.098243713379, 48.6100921630859],
      [-123.102066040039, 48.6040344238281],
      [-123.101547241211, 48.5978202819824],
      [-123.074600219727, 48.5918159484863],
      [-123.060028076172, 48.5821075439453],
      [-123.048393249512, 48.5692176818848],
      [-123.033660888672, 48.5634078979492],
      [-123.015037536621, 48.5608215332031],
      [-122.987289428711, 48.5618934631348],
      [-122.986099243164, 48.5699844360352],
      [-122.989639282227, 48.5746688842773],
      [-122.995018005371, 48.5781631469727],
      [-123.004791259766, 48.5807876586914],
      [-123.016639709473, 48.5802459716797],
      [-123.034088134766, 48.5917663574219],
      [-123.024894714355, 48.5944824218750],
      [-123.023422241211, 48.5994758605957],
      [-123.041175842285, 48.6119461059570],
      [-123.046524047852, 48.6114883422852],
      [-123.048645019531, 48.6210021972656],
      [-123.023483276367, 48.6340026855469],
      [-123.015579223633, 48.6425666809082],
      [-123.014816284180, 48.6475028991699],
      [-123.009910583496, 48.6550636291504],
      [-122.988876342773, 48.6672477722168],
      [-122.984840393066, 48.6726875305176],
      [-122.949104309082, 48.6933975219727],
      [-122.941307067871, 48.7029037475586],
      [-122.942359924316, 48.7067222595215],
      [-122.918243408203, 48.7135047912598],
      [-122.894592285156, 48.7150306701660],
      [-122.875930786133, 48.7121200561523],
      [-122.833114624023, 48.6981735229492],
      [-122.802536010742, 48.6826820373535],
      [-122.800262451172, 48.6796188354492],
      [-122.743041992188, 48.6619911193848],
      [-122.742073059082, 48.6606903076172],
      [-122.755020141602, 48.6495132446289],
      [-122.783866882324, 48.6354179382324],
      [-122.792137145996, 48.6335029602051],
      [-122.809616088867, 48.6190338134766],
      [-122.808853149414, 48.6153106689453],
      [-122.799003601074, 48.6046829223633],
      [-122.798759460449, 48.6023521423340],
      [-122.800209045410, 48.6016883850098],
      [-124.836097717285, 48.8048133468628]
    ]]
  }
};

const HomePage: React.FC = () => {
  const mapRef = useRef<SVGSVGElement>(null);
  const [selectedState, setSelectedState] = useState<'US' | 'WA'>('US');

  useEffect(() => {
    if (!mapRef.current) return;

    const width = 960;
    const height = 500;

    // Clear previous content
    d3.select(mapRef.current).selectAll("*").remove();

    const svg = d3.select(mapRef.current)
      .attr("viewBox", [0, 0, width, height])
      .attr("width", "100%")
      .attr("height", "100%");

    // Create a projection specifically for Washington state
    const projection = d3.geoMercator()
      .center([-120.7401, 47.7511]) // Center on Washington state
      .scale(4500)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    // Create tooltip
    const tooltip = d3.select("body").append("div")
      .attr("class", "absolute hidden bg-black text-white p-2 rounded text-sm")
      .style("pointer-events", "none");

    // Draw Washington state
    svg.selectAll("path")
      .data([washingtonCoordinates])
      .enter()
      .append("path")
      .attr("d", path)
      .attr("fill", "#4F46E5")
      .attr("stroke", "#fff")
      .attr("stroke-width", 1)
      .attr("opacity", 0.8)
      .on("mouseover", (event, d) => {
        d3.select(event.currentTarget)
          .attr("opacity", 1);
        
        tooltip
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 28) + "px")
          .html("Washington State")
          .classed("hidden", false);
      })
      .on("mouseout", (event) => {
        d3.select(event.currentTarget)
          .attr("opacity", 0.8);
        
        tooltip.classed("hidden", true);
      })
      .on("click", () => {
        setSelectedState(selectedState === 'WA' ? 'US' : 'WA');
      });

    return () => {
      tooltip.remove();
    };
  }, [selectedState]);

  const metrics = selectedState === 'WA' ? washingtonMetrics : usMetrics;
  const stats = {
    gini: metrics.find(m => m.id === 'gini')?.currentValue.toFixed(2),
    poverty: metrics.find(m => m.id === 'poverty-rate')?.currentValue.toFixed(1),
    wealth: metrics.find(m => m.id === 'wealth-top1')?.currentValue.toFixed(1)
  };

  return (
    <main className="container mx-auto px-4 py-6">
      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div className="lg:col-span-3">
          <ChatInterface onChatQuery={() => {}} />
        </div>
        
        <div className="lg:col-span-9">
          <div className="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 className="text-2xl font-bold mb-4">
              {selectedState === 'WA' ? 'Washington State' : 'United States'} Inequality Overview
            </h2>
            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="bg-indigo-50 p-4 rounded-lg">
                <h3 className="text-sm font-semibold text-indigo-800">Gini Coefficient</h3>
                <p className="text-2xl font-bold text-indigo-600">{stats.gini}</p>
              </div>
              <div className="bg-emerald-50 p-4 rounded-lg">
                <h3 className="text-sm font-semibold text-emerald-800">Poverty Rate</h3>
                <p className="text-2xl font-bold text-emerald-600">{stats.poverty}%</p>
              </div>
              <div className="bg-amber-50 p-4 rounded-lg">
                <h3 className="text-sm font-semibold text-amber-800">Top 1% Wealth Share</h3>
                <p className="text-2xl font-bold text-amber-600">{stats.wealth}%</p>
              </div>
            </div>
            <div className="w-full h-[500px] rounded-lg overflow-hidden">
              <svg ref={mapRef} className="w-full h-full" />
            </div>
          </div>
        </div>
      </div>
    </main>
  );
};

export default HomePage;